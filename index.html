<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© â€” HR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg-main: #020617;
      --bg-card: #020617;
      --accent: #06b6d4;
      --accent-soft: rgba(34, 211, 238, 0.1);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --danger: #dc2626;
      --warning: #f97316;
      --success: #16a34a;
      --info: #2563eb;
      --pill-bg: #111827;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%, #000 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      font-size: 15px;
      line-height: 1.5;
    }

    .page {
      width: 100%;
      max-width: 1300px;
      margin: 1.5rem auto 2rem;
      padding: 1rem;
    }

    @media (min-width: 768px) {
      .page {
        padding: 1.5rem;
      }
    }

    h1 {
      text-align: center;
      margin: 0 0 0.75rem;
      font-size: 1.9rem;
      letter-spacing: 0.04em;
      color: #38bdf8;
    }

    .subtitle {
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .card {
      background: radial-gradient(circle at top, #020617 0, #020617 60%, #020617 100%);
      border-radius: 24px;
      border: 1px solid var(--border-soft);
      padding: 1.25rem 1.25rem 1.5rem;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
      margin-bottom: 1.5rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .card-title span.icon {
      font-size: 1.3rem;
    }

    .hint {
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 0.75rem;
    }

    @media (min-width: 768px) {
      .grid {
        grid-template-columns: 2.3fr 1.7fr 1.5fr;
      }
    }

    .field-label {
      font-size: 0.82rem;
      margin-bottom: 0.3rem;
      color: var(--text-muted);
    }

    .field {
      display: flex;
      flex-direction: column;
    }

    .file-input-wrapper {
      position: relative;
      width: 100%;
    }

    .file-input {
      width: 100%;
      padding: 0.6rem 0.85rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background-color: #020617;
      color: transparent;
      cursor: pointer;
    }

    .file-input::file-selector-button {
      display: none;
    }

    .file-input-label-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      padding-inline: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .file-input-label-overlay span.name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70%;
      direction: ltr;
      text-align: left;
      unicode-bidi: plaintext;
      font-family: "Segoe UI", system-ui, sans-serif;
    }

    .file-input-label-overlay span.btn {
      pointer-events: none;
      background: var(--accent);
      color: #0f172a;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.75rem;
    }

    select {
      width: 100%;
      padding: 0.48rem 0.8rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background-color: #020617;
      background-image: linear-gradient(135deg, #020617, #020617);
      color: var(--text-main);
      font-size: 0.85rem;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(6, 182, 212, 0.6);
    }

    .select-inline-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .actions-row {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: flex-start;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1.3rem;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #e5e7eb;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.35);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #06b6d4, #0284c7);
      color: #e5e7eb;
      box-shadow: 0 10px 25px rgba(8, 145, 178, 0.35);
    }

    .btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: none;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }

    .btn span.icon {
      font-size: 1.05rem;
    }

    .summary-row {
      margin-bottom: 0.9rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .filter-btn {
      border-radius: 999px;
      border: 1px solid #111827;
      background: #020617;
      color: var(--text-muted);
      font-size: 0.8rem;
      padding: 0.25rem 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .filter-btn.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent);
    }

    .filter-count {
      font-weight: 600;
      color: #e5e7eb;
    }

    .search-box {
      margin-top: 0.3rem;
    }

    .search-input {
      width: 100%;
      max-width: 350px;
      padding: 0.45rem 0.8rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-main);
      font-size: 0.8rem;
      outline: none;
    }

    .search-input::placeholder {
      color: #6b7280;
    }

    .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(6, 182, 212, 0.5);
    }

    .table-wrapper {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 20px;
      border: 1px solid #1f2937;
      overflow: hidden;
    }

    .table-scroll {
      max-height: 460px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      direction: rtl;
    }

    thead {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
    }

    th,
    td {
      border-bottom: 1px solid #111827;
      padding: 0.25rem 0.4rem;
      text-align: center;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--text-muted);
      background: #020617;
    }

    tbody tr:nth-child(even) {
      background: #020617;
    }

    tbody tr:nth-child(odd) {
      background: #020617;
    }

    td.index-col {
      width: 30px;
      color: #9ca3af;
      font-weight: 500;
    }

    td.code-col {
      width: 70px;
      font-weight: 600;
      font-family: "Segoe UI", system-ui, sans-serif;
      direction: ltr;
    }

    td.name-col {
      min-width: 220px;
      max-width: 280px;
      text-align: right;
      padding-inline-start: 0.7rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    td.money-col,
    td.num-col {
      font-family: "Segoe UI", system-ui, sans-serif;
      direction: ltr;
      font-weight: 600;
      color: #e5e7eb;
    }

    td.money-col {
      min-width: 80px;
    }

    td.note-col {
      min-width: 200px;
      text-align: right;
      font-size: 0.76rem;
      color: var(--text-muted);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.1rem 0.7rem;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
      color: #f9fafb;
      background: var(--pill-bg);
      min-width: 130px;
    }

    .status-approved {
      background: var(--success);
    }

    .status-settle {
      background: var(--info);
    }

    .status-pending {
      background: var(--warning);
    }

    .status-reject {
      background: var(--danger);
    }

    .footer {
      margin-top: 1.2rem;
      text-align: center;
      font-size: 0.78rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Ù†Ø¸Ø§Ù… Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© â€” HR</h1>
    <div class="subtitle">
      Ù…Ù†Ø­ Ø³Ù„ÙØ© Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¹Ø§Ø¯Ù„Ø© ÙˆØ¢Ù…Ù†Ø©ØŒ Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØªÙ… Ø¯Ø§Ø®Ù„ Ù…ØªØµÙØ­Ùƒ (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª).
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">ğŸ“‚</span>
          <span>Ù…Ù„Ù ÙƒØ´Ù Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª (XLSX)</span>
        </div>
        <div class="hint">
          Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸ÙØŒ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙØŒ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØŒ Ø£ÙƒØ±Ø§Ù…ÙŠØ©ØŒ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ØŒ Ø³Ù„ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ØŒ Ø³Ù„ÙØ© Ù…Ù‚Ø³Ø·Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)ØŒ ØºÙŠØ§Ø¨ØŒ Ø¥Ø¬Ø§Ø²Ø© Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© Ø¨Ø±Ø§ØªØ¨ (Ø¥Ù† ÙˆØ¬Ø¯Øª)ØŒ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨.
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <div class="field-label">Ù…Ù„Ù ÙƒØ´Ù Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª</div>
          <div class="file-input-wrapper">
            <input id="file-input" type="file" accept=".xlsx,.xls" class="file-input" />
            <div class="file-input-label-overlay">
              <span class="name" id="file-name-label">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯â€¦</span>
              <span class="btn">Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§</span>
            </div>
          </div>
          <div class="select-inline-label">ÙŠÙØ¶Ù‘Ù„ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
        </div>

        <div class="field">
          <div class="field-label">Ù†ÙˆØ¹ Ø§Ù„ÙØ¦Ø©</div>
          <select id="category-select">
            <option value="workers">Ø§Ù„Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ù…Ø´Ø±ÙÙŠÙ† â€” Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ù„ÙØ© (30%)</option>
            <option value="admins">Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ† â€” Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ù„ÙØ© (25%)</option>
          </select>
          <div class="select-inline-label">
            Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„ÙƒØ´Ù Ø§Ù„Ø°ÙŠ Ø³ØªØ¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡.
          </div>
        </div>

        <div class="field">
          <div class="field-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù„ÙØ©</div>
          <select id="date-select"></select>
          <div class="select-inline-label">
            ÙŠØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø³Ù„ÙØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ†.
          </div>
        </div>
      </div>

      <div class="actions-row">
        <button id="process-btn" class="btn btn-primary">
          <span class="icon">ğŸš€</span>
          <span>Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨</span>
        </button>

        <button id="export-btn" class="btn btn-secondary" disabled>
          <span class="icon">ğŸ’¾</span>
          <span>ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø³Ù„ÙØ© XLSX</span>
        </button>
      </div>
    </div>

    <div class="card">
      <div class="summary-row">
        <button class="filter-btn active" data-filter="all">
          Ø§Ù„ÙƒÙ„
          <span class="filter-count" id="count-all">0</span>
        </button>
        <button class="filter-btn" data-filter="approved">
          Ø³Ù„ÙØ© Ù†Ø¸Ø§Ù…ÙŠØ©
          <span class="filter-count" id="count-approved">0</span>
        </button>
        <button class="filter-btn" data-filter="settle">
          ØªØµÙÙŠØ©/ØªØ¹Ø¨Ø¦Ø©
          <span class="filter-count" id="count-settle">0</span>
        </button>
        <button class="filter-btn" data-filter="reject">
          Ù…Ø±ÙÙˆØ¶Ø© / Ù„Ø§ ÙŠØ³ØªØ­Ù‚
          <span class="filter-count" id="count-reject">0</span>
        </button>
        <button class="filter-btn" data-filter="pending">
          ÙŠØªØ·Ù„Ø¨ ØªØ­Ù‚Ù‚
          <span class="filter-count" id="count-pending">0</span>
        </button>
      </div>

      <div class="search-box">
        <input id="search-input" class="search-input" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…â€¦" />
      </div>
    </div>

    <div class="table-wrapper">
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>Ù…</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
              <th>Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø©</th>
              <th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>
              <th>Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</th>
              <th>Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</th>
              <th id="advance-percent-header">Ø³Ù„ÙØ© % (25/30)</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø±Ø§Ø±</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù‚ØªØ±Ø­</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹ØªÙ…Ø¯</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
            </tr>
          </thead>
          <tbody id="results-body"></tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      Ù†Ø¸Ø§Ù… Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© â€” Ø§Ù„ÙŠÙ…Ù† â€¢ Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªÙ†ÙÙŠØ°: Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø­Ù…Ø¯ÙŠ Ø§Ù„Ø¹Ø±ÙŠÙ‚ÙŠ â€” Øª: 773143600 â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© 2025 Â©
    </div>
  </div>

  <script src="xlsx.full.min.js"></script>

  <script>
    const fileInput = document.getElementById("file-input");
    const fileNameLabel = document.getElementById("file-name-label");
    const processBtn = document.getElementById("process-btn");
    const exportBtn = document.getElementById("export-btn");
    const categorySelect = document.getElementById("category-select");
    const dateSelect = document.getElementById("date-select");
    const resultsBody = document.getElementById("results-body");
    const searchInput = document.getElementById("search-input");
    const filterButtons = Array.from(document.querySelectorAll(".filter-btn"));
    const advancePercentHeader = document.getElementById("advance-percent-header");

    const countAll = document.getElementById("count-all");
    const countApproved = document.getElementById("count-approved");
    const countSettle = document.getElementById("count-settle");
    const countReject = document.getElementById("count-reject");
    const countPending = document.getElementById("count-pending");

    let allResults = [];
    let currentFilter = "all";
    let currentSearch = "";
    let currentPercentLabel = "Ø³Ù„ÙØ© % (25/30)";

    const arabicDigits = "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©";

    function normalizeDigits(str) {
      return str.replace(/[Ù -Ù©]/g, d => arabicDigits.indexOf(d));
    }

    function toNumber(value) {
      if (value === null || value === undefined) return 0;
      if (typeof value === "number") return isNaN(value) ? 0 : value;
      let s = String(value).trim();
      if (!s) return 0;
      s = normalizeDigits(s);
      s = s.replace(/[^0-9.\-]/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    function roundMoney(v) {
      if (v === null || v === undefined || isNaN(v)) return "";
      return Math.round(v).toString();
    }

    function roundNumber(v, decimals = 1) {
      if (v === null || v === undefined || isNaN(v)) return "";
      const factor = Math.pow(10, decimals);
      return (Math.round(v * factor) / factor).toString();
    }

    function roundToHundredDown(v) {
      const n = Number(v);
      if (!n || isNaN(n) || n <= 0) return 0;
      return Math.floor(n / 100) * 100;
    }

    fileInput.addEventListener("change", () => {
      if (fileInput.files && fileInput.files[0]) {
        fileNameLabel.textContent = fileInput.files[0].name;
      } else {
        fileNameLabel.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯â€¦";
      }
    });

    function updatePercentHeader() {
      currentPercentLabel = categorySelect.value === "workers" ? "Ø³Ù„ÙØ© 30%" : "Ø³Ù„ÙØ© 25%";
      advancePercentHeader.textContent = currentPercentLabel;
    }

    function syncDateOptions() {
      const cat = categorySelect.value;
      dateSelect.innerHTML = "";
      if (cat === "workers") {
        const opt = document.createElement("option");
        opt.value = "15";
        opt.textContent = "ÙŠÙˆÙ… 15 Ù…Ù† Ø§Ù„Ø´Ù‡Ø± (Ø¹Ù…Ø§Ù„)";
        dateSelect.appendChild(opt);
      } else {
        const opt10 = document.createElement("option");
        opt10.value = "10";
        opt10.textContent = "ÙŠÙˆÙ… 10 Ù…Ù† Ø§Ù„Ø´Ù‡Ø± (Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ†)";
        const opt20 = document.createElement("option");
        opt20.value = "20";
        opt20.textContent = "ÙŠÙˆÙ… 20 Ù…Ù† Ø§Ù„Ø´Ù‡Ø± (Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ†)";
        dateSelect.appendChild(opt10);
        dateSelect.appendChild(opt20);
      }
    }

    categorySelect.addEventListener("change", () => {
      updatePercentHeader();
      syncDateOptions();
    });

    updatePercentHeader();
    syncDateOptions();

    processBtn.addEventListener("click", () => {
      if (!fileInput.files || !fileInput.files[0]) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙƒØ´Ù Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheetName];
          const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

          if (!rows || !rows.length) {
            alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙˆØ±Ù‚Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙÙˆÙ.");
            return;
          }

          const category = categorySelect.value;
          const advanceDate = dateSelect.value;
          allResults = processRows(rows, category, advanceDate);

          updateCounts();
          applyFilter("all");
          exportBtn.disabled = allResults.length === 0;
        } catch (err) {
          console.error(err);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© XLSX ØµØ­ÙŠØ­Ø©.");
        }
      };
      reader.readAsArrayBuffer(file);
    });

    function findColumn(headers, candidates) {
      const cleanedHeaders = headers.map(h => h.replace(/\s/g, ""));
      for (let c of candidates) {
        const cleanedCandidate = c.replace(/\s/g, "");
        const idx = cleanedHeaders.findIndex(h => h.includes(cleanedCandidate));
        if (idx !== -1) return headers[idx];
      }
      return null;
    }

    function processRows(rows, category, advanceDate) {
      const headers = Object.keys(rows[0]);
      const colCode = findColumn(headers, ["Ø±Ù‚Ù…Ø§Ù„Ù…ÙˆØ¸Ù", "Ø§Ù„ÙƒÙˆØ¯"]);
      const colName = findColumn(headers, ["Ø§Ø³Ù…Ø§Ù„Ù…ÙˆØ¸Ù", "Ø§Ù„Ø§Ø³Ù…"]);
      const colBasic = findColumn(headers, ["Ø§Ù„Ø±Ø§ØªØ¨Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ"]);
      const colBonus = findColumn(headers, ["Ø§ÙƒØ±Ø§Ù…ÙŠØ©", "Ø§Ù„Ø¥ÙƒØ±Ø§Ù…ÙŠØ©"]);
      const colGross = findColumn(headers, ["Ø§Ø¬Ù…Ø§Ù„ÙŠØ§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚"]);
      const colLoan = findColumn(headers, ["Ø³Ù„ÙØ©Ø¹Ù„Ù‰Ø§Ù„Ø±Ø§ØªØ¨"]);
      const colInstLoan = findColumn(headers, ["Ø³Ù„ÙØ©Ù…Ù‚Ø³Ø·Ø©"]);
      const colAbsenceMoney = findColumn(headers, ["ØºÙŠØ§Ø¨"]);
      const colAbsenceDays = findColumn(headers, ["Ø§ÙŠØ§Ù…ØºÙŠØ§Ø¨", "Ø§ÙŠØ§Ù…Øº", "Ø£ÙŠØ§Ù…ØºÙŠØ§Ø¨"]);
      const colForcedLeave = findColumn(headers, ["Ø§Ø¬Ø§Ø²Ø©Ø§Ø¬Ø¨Ø§Ø±ÙŠØ©Ø¨Ø±Ø§ØªØ¨"]);
      const colNet = findColumn(headers, ["ØµØ§ÙÙŠØ§Ù„Ø±Ø§ØªØ¨", "ØµØ§ÙÙŠØ±Ø§ØªØ¨"]);

      if (!colCode || !colName || !colBasic || !colBonus || !colGross || !colNet) {
        alert("Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù (Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸ÙØŒ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙØŒ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØŒ Ø§Ù„Ø£ÙƒØ±Ø§Ù…ÙŠØ©ØŒ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ØŒ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨).");
        return [];
      }

      const results = [];
      const percent = category === "workers" ? 0.30 : 0.25;
      const monthlyCapPercent =
        category === "workers"
          ? 0.30
          : (advanceDate === "10" ? 0.25 : 0.50);

      currentPercentLabel = category === "workers" ? "Ø³Ù„ÙØ© 30%" : "Ø³Ù„ÙØ© 25%";
      advancePercentHeader.textContent = currentPercentLabel;

      rows.forEach((row, idx) => {
        const index = idx + 1;
        const code = row[colCode];
        const name = row[colName];

        const basic = toNumber(row[colBasic]);
        const bonus = toNumber(row[colBonus]);
        let gross = basic + bonus;
        const grossSystem = colGross ? toNumber(row[colGross]) : 0;
        if (grossSystem > 0 && Math.abs(grossSystem - gross) > 1) {
          gross = basic + bonus;
        }

        const net = toNumber(row[colNet]);
        const loanOnSalary = colLoan ? toNumber(row[colLoan]) : 0;
        const instLoan = colInstLoan ? toNumber(row[colInstLoan]) : 0;
        const existingLoan = loanOnSalary + instLoan;

        const dayWage = gross > 0 ? gross / 30 : 0;

        let absenceDays = 0;
        if (colAbsenceDays) {
          absenceDays = toNumber(row[colAbsenceDays]);
        } else if (colAbsenceMoney) {
          const absenceMoney = toNumber(row[colAbsenceMoney]);
          absenceDays = dayWage > 0 ? absenceMoney / dayWage : 0;
        }

        const forcedLeaveMoney = colForcedLeave ? toNumber(row[colForcedLeave]) : 0;
        const perDayBonus = bonus > 0 ? (bonus / 30) : 0;
        const forcedDays = perDayBonus > 0 ? (forcedLeaveMoney / perDayBonus) : 0;

        const totalAbsence = absenceDays + forcedDays;
        const presenceDays = Math.max(0, 30 - totalAbsence);

        let percentBaseAmount = roundToHundredDown(gross * percent);
        const monthlyCapAmount = gross * monthlyCapPercent;

        let decisionType = "";
        let status = "";
        let suggestedAmount = 0;
        let finalAmount = 0;
        let note = "";

        if (totalAbsence >= 30) {
          status = "reject";
          decisionType = "Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ© â€” ØºÙŠØ§Ø¨ 30 ÙŠÙˆÙ…";
          note = "Ø§Ù„Ø¹Ø§Ù…Ù„ Ù…Ù†Ù‚Ø·Ø¹ Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ 30 ÙŠÙˆÙ…Ù‹Ø§ (Ø£Ùˆ Ø£ÙƒØ«Ø±)ØŒ Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.";
        } else if (net <= 0) {
          status = "reject";
          decisionType = "Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ© â€” Ø±ØµÙŠØ¯Ù‡ Ù„Ø§ ÙŠØ³Ù…Ø­";
          note = "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨ ÙŠØ³Ø§ÙˆÙŠ ØµÙØ± Ø£Ùˆ Ø£Ù‚Ù„Ø› Ø±Ø¨Ù…Ø§ ØªÙ…Øª ØªØµÙÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ Ù…ØªØ§Ø­.";
        } else {
          if (category === "workers") {
            if (presenceDays >= 10) {
              suggestedAmount = percentBaseAmount;
              decisionType = "Ø³Ù„ÙØ© Ù†Ø³Ø¨Ø© (" + Math.round(percent * 100) + "%)";
              status = "approved";
            } else {
              const base = Math.min(net, percentBaseAmount);
              suggestedAmount = base;
              decisionType = "ØªØµÙÙŠØ© (Ø£Ù‚Ù„ Ù…Ù† 10 Ø£ÙŠØ§Ù… Ø­Ø¶ÙˆØ±)";
              status = "settle";
            }
          } else {
            const absenceForRule = totalAbsence;
            if (absenceForRule <= 3) {
              suggestedAmount = percentBaseAmount;
              decisionType = "Ø³Ù„ÙØ© Ù†Ø³Ø¨Ø© (" + Math.round(percent * 100) + "%)";
              status = "approved";
            } else {
              const base = Math.min(net, percentBaseAmount);
              suggestedAmount = base;
              decisionType = "ØªØµÙÙŠØ© (ØºÙŠØ§Ø¨ Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„ÙØªØ±Ø©)";
              status = "settle";
            }
          }

          finalAmount = suggestedAmount;

          if (loanOnSalary > 0) {
            if (loanOnSalary >= monthlyCapAmount) {
              status = "reject";
              decisionType = "Ù…Ø±ÙÙˆØ¶ â€” Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© â‰¥ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ";
              suggestedAmount = 0;
              finalAmount = 0;
              note =
                `Ø³Ù„ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† = ${roundMoney(loanOnSalary)} ` +
                `â‰¥ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (${roundMoney(monthlyCapAmount)}). Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù†ÙØ³ Ø§Ù„Ø´Ù‡Ø±.`;
            } else {
              status = "pending";
              const remainingForMonth = monthlyCapAmount - loanOnSalary;
              const allowedThisRun = Math.min(percentBaseAmount, remainingForMonth);
              suggestedAmount = allowedThisRun;
              finalAmount = allowedThisRun;
              decisionType = "ÙŠØªØ·Ù„Ø¨ ØªØ­Ù‚Ù‚ â€” Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„Ø´Ù‡Ø±";
              note =
                `Ø³Ù„ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† = ${roundMoney(loanOnSalary)} Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ (${roundMoney(monthlyCapAmount)}). ` +
                `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± = ${roundMoney(remainingForMonth)}ØŒ ` +
                `ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù‚ØªØ±Ø­ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© = ${roundMoney(allowedThisRun)}.`;
            }
          }
        }

        percentBaseAmount = roundToHundredDown(percentBaseAmount);
        suggestedAmount = roundToHundredDown(suggestedAmount);
        finalAmount = roundToHundredDown(finalAmount);

        const statusLabel = {
          approved: "Ø³Ù„ÙØ© Ù†Ø¸Ø§Ù…ÙŠØ©",
          settle: "ØªØµÙÙŠØ©/ØªØ¹Ø¨Ø¦Ø©",
          pending: "ÙŠØªØ·Ù„Ø¨ ØªØ­Ù‚Ù‚",
          reject: "Ù„Ø§ ÙŠØ³ØªØ­Ù‚ / Ù…Ø±ÙÙˆØ¶"
        }[status] || status;

        results.push({
          index,
          code,
          name,
          gross,
          existingLoan,
          net,
          totalAbsence,
          presenceDays,
          percentBaseAmount,
          decisionType,
          suggestedAmount,
          finalAmount,
          status,
          statusLabel,
          note
        });
      });

      return results;
    }

    function updateCounts() {
      const total = allResults.length;
      const approved = allResults.filter(r => r.status === "approved").length;
      const settle = allResults.filter(r => r.status === "settle").length;
      const reject = allResults.filter(r => r.status === "reject").length;
      const pending = allResults.filter(r => r.status === "pending").length;

      countAll.textContent = total;
      countApproved.textContent = approved;
      countSettle.textContent = settle;
      countReject.textContent = reject;
      countPending.textContent = pending;
    }

    function applyFilter(filter) {
      currentFilter = filter;
      renderTable();
      filterButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.filter === filter);
      });
    }

    function renderTable() {
      resultsBody.innerHTML = "";
      const fragment = document.createDocumentFragment();

      const filtered = allResults.filter(r => {
        if (currentFilter !== "all" && r.status !== currentFilter) return false;
        if (!currentSearch) return true;
        const s = currentSearch.toLowerCase();
        const code = String(r.code || "").toLowerCase();
        const name = String(r.name || "").toLowerCase();
        return code.includes(s) || name.includes(s);
      });

      filtered.forEach(r => {
        const tr = document.createElement("tr");
        const statusClass = {
          approved: "status-approved",
          settle: "status-settle",
          pending: "status-pending",
          reject: "status-reject"
        }[r.status] || "";

        tr.innerHTML = `
          <td class="index-col">${r.index}</td>
          <td class="code-col">${r.code || ""}</td>
          <td class="name-col">${r.name || ""}</td>
          <td class="money-col">${roundMoney(r.gross)}</td>
          <td class="money-col">${roundMoney(r.existingLoan)}</td>
          <td class="money-col">${roundMoney(r.net)}</td>
          <td class="num-col">${roundNumber(r.totalAbsence)}</td>
          <td class="num-col">${roundNumber(r.presenceDays)}</td>
          <td class="money-col">${roundMoney(r.percentBaseAmount)}</td>
          <td>${r.decisionType || ""}</td>
          <td class="money-col">${roundMoney(r.suggestedAmount)}</td>
          <td class="money-col">${roundMoney(r.finalAmount)}</td>
          <td><span class="status-pill ${statusClass}">${r.statusLabel || ""}</span></td>
          <td class="note-col">${r.note || ""}</td>
        `;
        fragment.appendChild(tr);
      });

      resultsBody.appendChild(fragment);
    }

    filterButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        applyFilter(btn.dataset.filter);
      });
    });

    searchInput.addEventListener("input", () => {
      currentSearch = searchInput.value.trim().toLowerCase();
      renderTable();
    });

    exportBtn.addEventListener("click", () => {
      if (!allResults.length) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");
        return;
      }

      const wb = XLSX.utils.book_new();

      const sheet1Header = [
        "Ù…",
        "Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
        "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
        "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚",
        "Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø©",
        "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨",
        "Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨",
        "Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±",
        currentPercentLabel,
        "Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø±Ø§Ø±",
        "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù‚ØªØ±Ø­",
        "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹ØªÙ…Ø¯",
        "Ø§Ù„Ø­Ø§Ù„Ø©",
        "Ù…Ù„Ø§Ø­Ø¸Ø©"
      ];

      const sheet1Data = [sheet1Header];

      allResults.forEach(r => {
        sheet1Data.push([
          r.index,
          r.code || "",
          r.name || "",
          roundMoney(r.gross),
          roundMoney(r.existingLoan),
          roundMoney(r.net),
          roundNumber(r.totalAbsence),
          roundNumber(r.presenceDays),
          roundMoney(r.percentBaseAmount),
          r.decisionType || "",
          roundMoney(r.suggestedAmount),
          roundMoney(r.finalAmount),
          r.statusLabel || "",
          r.note || ""
        ]);
      });

      const ws1 = XLSX.utils.aoa_to_sheet(sheet1Data);
      XLSX.utils.book_append_sheet(wb, ws1, "ØªÙØµÙŠÙ„ÙŠ");

      const payable = allResults.filter(r => r.finalAmount > 0);
      const ws2 = {};

      payable.forEach((r, i) => {
        const rowIndex = i;
        const sourceRow = r.index + 1;

        const addrA = XLSX.utils.encode_cell({ r: rowIndex, c: 0 });
        const addrB = XLSX.utils.encode_cell({ r: rowIndex, c: 1 });
        const addrC = XLSX.utils.encode_cell({ r: rowIndex, c: 2 });
        const addrD = XLSX.utils.encode_cell({ r: rowIndex, c: 3 });

        ws2[addrA] = { t: "s", v: String(r.code || "") };
        ws2[addrB] = { t: "s", v: String(r.name || "") };
        ws2[addrC] = {
          t: "n",
          v: Number(r.finalAmount),
          f: `ØªÙØµÙŠÙ„ÙŠ!L${sourceRow}`
        };
        ws2[addrD] = { t: "s", v: "YER" };
      });

      if (payable.length > 0) {
        ws2["!ref"] = XLSX.utils.encode_range({
          s: { r: 0, c: 0 },
          e: { r: payable.length - 1, c: 3 }
        });
      } else {
        ws2["!ref"] = "A1:D1";
      }

      XLSX.utils.book_append_sheet(wb, ws2, "Ù„Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ©");

      const fileName = "canary_monthly_advance.xlsx";
      XLSX.writeFile(wb, fileName);
    });
  </script>
</body>
</html>