<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HR â€” Ù†Ø¸Ø§Ù… Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</title>

  <!-- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª -->
  <style>
    :root {
      --bg-main: radial-gradient(circle at top, #082f49 0, #020617 42%, #000 100%);
      --card-bg: rgba(15, 23, 42, 0.98);
      --card-border: rgba(148, 163, 184, 0.18);
      --accent: #0ea5e9;
      --accent-soft: rgba(56, 189, 248, 0.18);
      --accent-strong: #38bdf8;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.12);
      --warning: #f97316;
      --warning-soft: rgba(249, 115, 22, 0.12);
      --success: #22c55e;
      --success-soft: rgba(34, 197, 94, 0.14);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --chip-bg: #020617;
      --chip-border: #111827;
      --input-bg: rgba(15, 23, 42, 0.95);
      --input-border: #1f2937;
      --table-header-bg: #020617;
      --table-row-alt: rgba(15, 23, 42, 0.6);
      --badge-radius: 999px;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
    }

    body {
      display: flex;
      justify-content: center;
      padding: 1.5rem 0.75rem 4rem;
    }

    .page {
      width: 100%;
      max-width: 1100px;
    }

    h1 {
      margin: 0 0 0.5rem;
      font-size: clamp(1.85rem, 4vw, 2.4rem);
      letter-spacing: 0.04em;
      text-align: center;
    }

    h1 span {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    h1 .emoji {
      font-size: 1.5em;
    }

    .subtitle {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.95rem;
      margin-bottom: 1.5rem;
    }

    /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
    .card {
      background: var(--card-bg);
      border-radius: 1.4rem;
      border: 1px solid var(--card-border);
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      padding: 1.4rem 1.25rem;
      margin-bottom: 1.25rem;
      backdrop-filter: blur(18px);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .card-title {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      font-size: 1.02rem;
    }

    .card-title span.emoji {
      font-size: 1.2rem;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.6;
    }

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ */
    .grid {
      display: grid;
      gap: 0.75rem;
    }

    @media (min-width: 720px) {
      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .grid-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.85rem;
    }

    .field-label {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      color: var(--text-muted);
    }

    .field-label span.emoji {
      font-size: 1.1rem;
    }

    .field-tip {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    /* Ù…Ø¯Ø®Ù„Ø§Øª */
    input[type="file"],
    select,
    input[type="number"],
    input[type="text"] {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      padding: 0.45rem 0.95rem;
      color: var(--text-main);
      font-size: 0.85rem;
      outline: none;
      transition: border-color 0.16s ease, box-shadow 0.16s ease,
        background 0.16s ease;
      direction: rtl;
    }

    input::file-selector-button {
      border: none;
      border-radius: 999px;
      padding: 0.35rem 0.9rem;
      margin-inline-end: 0.6rem;
      background: var(--accent);
      color: #0b1120;
      font-weight: 600;
      cursor: pointer;
    }

    select:focus,
    input[type="number"]:focus,
    input[type="text"]:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.7);
    }

    input[disabled],
    select[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Ø£Ø²Ø±Ø§Ø± */
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.65rem;
      margin-top: 0.75rem;
      justify-content: center;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.6rem 1.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease, opacity 0.12s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      box-shadow: 0 12px 30px rgba(22, 163, 74, 0.45);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(22, 163, 74, 0.65);
    }

    .btn-secondary {
      background: #0f172a;
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .btn-secondary:hover {
      background: #020617;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.6rem;
      margin-top: 0.75rem;
    }

    .stat-pill {
      border-radius: 999px;
      padding: 0.4rem 0.65rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      gap: 0.1rem;
    }

    .stat-pill strong {
      font-size: 0.95rem;
      letter-spacing: 0.04em;
    }

    .stat-total {
      background: radial-gradient(circle at top, #1d4ed8 0, #020617 80%);
      border: 1px solid rgba(129, 140, 248, 0.8);
    }

    .stat-normal {
      background: var(--success-soft);
      border: 1px solid rgba(34, 197, 94, 0.7);
    }

    .stat-settle {
      background: var(--accent-soft);
      border: 1px solid rgba(56, 189, 248, 0.7);
    }

    .stat-review {
      background: var(--warning-soft);
      border: 1px solid rgba(249, 115, 22, 0.7);
    }

    .stat-reject {
      background: var(--danger-soft);
      border: 1px solid rgba(239, 68, 68, 0.7);
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø© */
    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.8rem;
      justify-content: center;
    }

    .filter-btn {
      border-radius: var(--badge-radius);
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      color: var(--text-muted);
      font-size: 0.75rem;
      padding: 0.3rem 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      cursor: pointer;
      transition: all 0.12s ease;
      user-select: none;
      -webkit-user-select: none;
    }

    .filter-btn span.count {
      min-width: 1.4rem;
      text-align: center;
      border-radius: 999px;
      padding: 0.05rem 0.35rem;
      background: rgba(15, 23, 42, 0.9);
      font-variant-numeric: tabular-nums;
      font-size: 0.7rem;
    }

    .filter-btn.active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
    }

    /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .results-card {
      margin-top: 1.25rem;
    }

    .table-wrapper {
      margin-top: 0.5rem;
      border-radius: 1.2rem;
      border: 1px solid var(--card-border);
      overflow: hidden;
      background: rgba(15, 23, 42, 0.95);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    thead {
      background: var(--table-header-bg);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    thead th {
      padding: 0.45rem 0.4rem;
      font-weight: 600;
      color: var(--text-muted);
      border-bottom: 1px solid #1f2937;
      white-space: nowrap;
    }

    tbody tr {
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
    }

    tbody tr:nth-child(even) {
      background: var(--table-row-alt);
    }

    td {
      padding: 0.35rem 0.4rem;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 220px;
      vertical-align: middle;
    }

    td.num {
      text-align: center;
      font-variant-numeric: tabular-nums;
      direction: ltr;
    }

    td.amount {
      text-align: center;
      font-variant-numeric: tabular-nums;
      direction: ltr;
      font-weight: 600;
    }

    /* Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
    .col-m      { width: 2.4rem; }
    .col-code   { width: 4.4rem; }
    .col-name   { width: 18rem; }
    .col-total  { width: 6rem; }
    .col-prev   { width: 5.8rem; }
    .col-net    { width: 6rem; }
    .col-days   { width: 4.2rem; }
    .col-rate   { width: 4.4rem; }
    .col-type   { width: 6.8rem; }
    .col-status { width: 6.2rem; }
    .col-note   { width: 18rem; }

    /* Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø­Ø§Ù„Ø© */
    .badge {
      border-radius: 999px;
      padding: 0.1rem 0.5rem;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .status-normal {
      background: var(--success-soft);
      color: var(--success);
    }

    .status-settle {
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .status-review {
      background: var(--warning-soft);
      color: var(--warning);
    }

    .status-reject {
      background: var(--danger-soft);
      color: var(--danger);
    }

    tbody tr.status-normal-row {
      background: radial-gradient(circle at center, rgba(34, 197, 94, 0.14), rgba(15, 23, 42, 0.95));
    }

    tbody tr.status-review-row {
      background: radial-gradient(circle at center, rgba(249, 115, 22, 0.16), rgba(15, 23, 42, 0.96));
    }

    tbody tr.status-reject-row {
      background: radial-gradient(circle at center, rgba(239, 68, 68, 0.18), rgba(15, 23, 42, 0.97));
    }

    /* ÙÙˆØªØ± */
    .footer {
      margin-top: 1.25rem;
      text-align: center;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .footer strong {
      color: var(--accent-strong);
    }

    .footer a {
      color: var(--accent-strong);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* Ø³ÙƒØ±ÙˆÙ„ */
    .table-scroll {
      max-height: 420px;
      overflow: auto;
    }

    /* Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    @media (max-width: 640px) {
      body {
        padding: 0.75rem 0.35rem 3.5rem;
      }

      .card {
        padding: 1.1rem 0.9rem;
      }

      .stats-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .col-name,
      .col-note {
        max-width: 160px;
      }

      table {
        font-size: 0.75rem;
      }
    }
  </style>

  <!-- Ù…ÙƒØªØ¨Ø© Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„ÙØ§Øª XLSX (Ù…Ø­Ù„ÙŠÙ‹Ø§) -->
  <script src="xlsx.full.min.js"></script>
</head>
<body>
  <main class="page">
    <header>
      <h1>
        <span>
          <span class="emoji">ğŸ’°</span>
          HR â€” Ù†Ø¸Ø§Ù… Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
        </span>
      </h1>
      <p class="subtitle">
        Ù…Ù†Ø­ Ø³Ù„ÙØ© Ø´Ù‡Ø±ÙŠØ© Ø¹Ø§Ø¯Ù„Ø© ÙˆØ¢Ù…Ù†Ø©ØŒ Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡. ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØªÙ… Ø¯Ø§Ø®Ù„ Ù…ØªØµÙØ­Ùƒ
        (Ù„Ø§ ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø®Ø§Ø¯Ù…).
      </p>
    </header>

    <!-- ÙƒØ§Ø±Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">ğŸ“‚</span>
          Ù…Ù„Ù ÙƒØ´Ù Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª (XLSX)
        </div>
      </div>
      <p class="card-subtitle">
        Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸ÙØŒ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙØŒ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØŒ Ø£ÙƒØ±Ø§Ù…ÙŠØ©ØŒ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ØŒ
        Ø³Ù„ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ØŒ Ø³Ù„ÙØ© Ù…Ù‚Ø³Ø·Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)ØŒ ØºÙŠØ§Ø¨ØŒ Ø¥Ø¬Ø§Ø²Ø© Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© Ø¨Ø±Ø§ØªØ¨ (Ø¥Ù† ÙˆØ¬Ø¯Øª)ØŒ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨.
        ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø«Ù„ Ø§Ù„ØªØ£Ø®ÙŠØ± Ø£Ùˆ Ø§Ù„ØªØ£Ù…ÙŠÙ† ÙˆÙ„Ø§ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù….
      </p>

      <div class="grid grid-2" style="margin-top:0.75rem;">
        <div class="field">
          <label class="field-label">
            <span class="emoji">ğŸ“</span>
            Ù…Ù„Ù ÙƒØ´Ù Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª
          </label>
          <input type="file" id="fileInput" accept=".xlsx,.xls" />
          <div class="field-tip">
            ÙŠÙÙØ¶Ù‘Ù„ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ù…ØµØ¯Ø±Ù‹Ø§ Ù…Ø¨Ø§Ø´Ø±Ù‹Ø§ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙŠØ¯ÙˆÙŠØ©.
          </div>
        </div>

        <div class="field">
          <label class="field-label">
            <span class="emoji">ğŸ‘¥</span>
            Ù†ÙˆØ¹ Ø§Ù„ÙØ¦Ø©
          </label>
          <select id="categorySelect">
            <option value="workers" selected>Ø§Ù„Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ù…Ø´Ø±ÙÙŠÙ† â€” Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ù„ÙØ© (30%)</option>
            <option value="admins">Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ† â€” Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ù„ÙØ© (25%)</option>
          </select>
          <div class="field-tip">
            Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„ÙƒØ´Ù Ø§Ù„Ø°ÙŠ Ø³ØªÙ‚ÙˆÙ… Ø¨Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡.
          </div>
        </div>
      </div>

      <div class="grid grid-3" style="margin-top:0.75rem;">
        <div class="field">
          <label class="field-label">
            <span class="emoji">ğŸ“…</span>
            ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù„ÙØ©
          </label>
          <select id="dateSelect">
            <!-- ÙŠØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© -->
          </select>
          <div class="field-tip">
            Ù„Ù„Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ù…Ø´Ø±ÙÙŠÙ†: ÙŠÙˆÙ… 15 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±. Ù„Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ†: ÙŠÙˆÙ… 10 Ø£Ùˆ 20.
          </div>
        </div>

        <div class="field" id="adminMinDaysField">
          <label class="field-label">
            <span class="emoji">âœ…</span>
            Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± (Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ† â€“ Ø³Ù„ÙØ© ÙŠÙˆÙ… 10)
          </label>
          <input
            type="number"
            id="adminMinDaysInput"
            min="1"
            max="30"
            step="1"
            value="7"
          />
          <div class="field-tip">
            Ù…Ø«Ø§Ù„: 7 ÙŠØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø§Ù„Ø°ÙŠ Ø­Ø¶Ø± 7 Ø£ÙŠØ§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø± Ø­ØªÙ‰ ÙŠÙˆÙ… 10 ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ© Ù†Ø¸Ø§Ù…ÙŠØ© (25%).
          </div>
        </div>

        <div class="field">
          <label class="field-label">
            <span class="emoji">â„¹ï¸</span>
            Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø´Ø±ÙˆØ· Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ©
          </label>
          <div class="field-tip">
            <ul style="margin:0;padding-inline-start:1.2rem;">
              <li>Ø§Ù„Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ù…Ø´Ø±ÙÙˆÙ†: Ø­Ø¶ÙˆØ± 10 Ø£ÙŠØ§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø± âœ Ø³Ù„ÙØ© 30%.</li>
              <li>Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠÙˆÙ† ÙŠÙˆÙ… 10: Ø­Ø¶ÙˆØ± â‰¥ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ âœ Ø³Ù„ÙØ© 25%.</li>
              <li>Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠÙˆÙ† ÙŠÙˆÙ… 20: Ø¥Ø°Ø§ Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© â‰¥ 50% âœ Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ©.</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button id="startBtn" class="btn btn-primary" disabled>
          ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨
        </button>
        <button id="downloadBtn" class="btn btn-secondary" disabled>
          ğŸ’¾ ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø³Ù„ÙØ© XLSX
        </button>
      </div>

      <!-- Ø¥Ø­ØµØ§Ø¡Ø§Øª -->
      <div class="stats-row">
        <div class="stat-pill stat-total">
          <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
          <strong id="statTotal">0</strong>
        </div>
        <div class="stat-pill stat-normal">
          <div>Ø³Ù„ÙØ© Ù†Ø¸Ø§Ù…ÙŠØ© (Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§)</div>
          <strong id="statNormal">0</strong>
        </div>
        <div class="stat-pill stat-settle">
          <div>ØªØµÙÙŠØ© / ØªØ¹Ø¨Ø¦Ø©</div>
          <strong id="statSettle">0</strong>
        </div>
        <div class="stat-pill stat-review">
          <div>ÙŠØªØ·Ù„Ø¨ ØªØ­Ù‚Ù‚</div>
          <strong id="statReview">0</strong>
        </div>
        <div class="stat-pill stat-reject">
          <div>Ù„Ø§ ÙŠØ³ØªØ­Ù‚ / Ù…Ø±ÙÙˆØ¶</div>
          <strong id="statReject">0</strong>
        </div>
      </div>

      <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø© -->
      <div class="filters-row">
        <button class="filter-btn active" data-filter="all">
          Ø§Ù„ÙƒÙ„
          <span class="count" id="countAll">0</span>
        </button>
        <button class="filter-btn" data-filter="normal">
          Ø³Ù„ÙØ© Ù†Ø¸Ø§Ù…ÙŠØ©
          <span class="count" id="countNormal">0</span>
        </button>
        <button class="filter-btn" data-filter="settlement">
          ØªØµÙÙŠØ© / ØªØ¹Ø¨Ø¦Ø©
          <span class="count" id="countSettle">0</span>
        </button>
        <button class="filter-btn" data-filter="review">
          ÙŠØªØ·Ù„Ø¨ ØªØ­Ù‚Ù‚
          <span class="count" id="countReview">0</span>
        </button>
        <button class="filter-btn" data-filter="rejected">
          Ù„Ø§ ÙŠØ³ØªØ­Ù‚ / Ù…Ø±ÙÙˆØ¶
          <span class="count" id="countRejected">0</span>
        </button>
      </div>
    </section>

    <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
    <section class="card results-card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">ğŸ“Š</span>
          Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
        </div>
      </div>

      <div class="table-wrapper">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th class="col-m">Ù…</th>
                <th class="col-code">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th class="col-name">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th class="col-total">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                <th class="col-prev">Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø©</th>
                <th class="col-net">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>
                <th class="col-days">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</th>
                <th class="col-days">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                <th class="col-rate">Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ù„ÙØ©</th>
                <th class="col-type">Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø±Ø§Ø±</th>
                <th class="col-total">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù‚ØªØ±Ø­</th>
                <th class="col-total">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹ØªÙ…Ø¯</th>
                <th class="col-status">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th class="col-note">Ù…Ù„Ø§Ø­Ø¸Ø©</th>
              </tr>
            </thead>
            <tbody id="resultsBody">
              <!-- Ø§Ù„ØµÙÙˆÙ ØªÙØ¶Ø§Ù Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="footer">
      Ù†Ø¸Ø§Ù… Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© â€” HR â€¢ ØªØµÙ…ÙŠÙ… ÙˆØ¥Ø¹Ø¯Ø§Ø¯:
      <strong>Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø­Ù…Ø¯ÙŠ Ø§Ù„Ø¹Ø±ÙŠÙ‚ÙŠ</strong> â€” Øª:
      <a href="tel:773143600">773143600</a> â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025
    </footer>
  </main>

  <script>
    // Ø¹Ù†Ø§ØµØ± DOM
    const fileInput = document.getElementById("fileInput");
    const categorySelect = document.getElementById("categorySelect");
    const dateSelect = document.getElementById("dateSelect");
    const adminMinDaysField = document.getElementById("adminMinDaysField");
    const adminMinDaysInput = document.getElementById("adminMinDaysInput");
    const startBtn = document.getElementById("startBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const resultsBody = document.getElementById("resultsBody");

    const statTotal = document.getElementById("statTotal");
    const statNormal = document.getElementById("statNormal");
    const statSettle = document.getElementById("statSettle");
    const statReview = document.getElementById("statReview");
    const statReject = document.getElementById("statReject");

    const countAll = document.getElementById("countAll");
    const countNormal = document.getElementById("countNormal");
    const countSettle = document.getElementById("countSettle");
    const countReview = document.getElementById("countReview");
    const countRejected = document.getElementById("countRejected");

    const filterButtons = Array.from(document.querySelectorAll(".filter-btn"));

    let parsedRows = [];
    let currentFilter = "all";

    function showAlert(msg) {
      alert(msg);
    }

    function normalizeHeader(h) {
      if (!h && h !== 0) return "";
      return String(h).replace(/\s+/g, "").toLowerCase();
    }

    function toNumber(value) {
      if (value == null || value === "") return 0;
      const num = Number(String(value).replace(/[^\d.\-]/g, ""));
      return isNaN(num) ? 0 : num;
    }

    function roundToHundreds(value) {
      if (!isFinite(value) || value <= 0) return 0;
      return Math.floor(value / 100) * 100;
    }

    function updateDateOptions() {
      const category = categorySelect.value;
      dateSelect.innerHTML = "";

      if (category === "workers") {
        const opt = document.createElement("option");
        opt.value = "15";
        opt.textContent = "ÙŠÙˆÙ… 15 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±";
        dateSelect.appendChild(opt);
        adminMinDaysField.style.display = "none";
      } else {
        const opt10 = document.createElement("option");
        opt10.value = "10";
        opt10.textContent = "ÙŠÙˆÙ… 10 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±";
        const opt20 = document.createElement("option");
        opt20.value = "20";
        opt20.textContent = "ÙŠÙˆÙ… 20 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±";
        dateSelect.appendChild(opt10);
        dateSelect.appendChild(opt20);
        adminMinDaysField.style.display = dateSelect.value === "10" ? "block" : "none";
      }
    }

    categorySelect.addEventListener("change", () => {
      updateDateOptions();
      validateReady();
    });

    dateSelect.addEventListener("change", () => {
      if (categorySelect.value === "admins") {
        adminMinDaysField.style.display = dateSelect.value === "10" ? "block" : "none";
      }
    });

    function validateReady() {
      startBtn.disabled = !fileInput.files || fileInput.files.length === 0;
    }

    fileInput.addEventListener("change", validateReady);

    updateDateOptions();

    // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„
    function readWorkbook(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = e.target.result;
            const workbook = XLSX.read(data, { type: "binary" });
            resolve(workbook);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = (err) => reject(err);
        reader.readAsBinaryString(file);
      });
    }

    function buildRowsFromSheet(sheet, category, advanceDay, adminMinDays) {
      const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      if (!sheetData.length) {
        showAlert("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª.");
        return [];
      }

      const headerRow = sheetData[0];
      const headersNorm = headerRow.map(normalizeHeader);

      function findIndex(predicates) {
        for (let i = 0; i < headersNorm.length; i++) {
          const h = headersNorm[i];
          if (predicates.some((p) => h.includes(p))) return i;
        }
        return -1;
      }

      const idxCode = findIndex(["Ø±Ù‚Ù…Ø§Ù„Ù…ÙˆØ¸Ù", "Ø±Ù‚Ù…Ø§Ù„Ø¹Ø§Ù…Ù„", "Ø§Ù„ÙƒÙˆØ¯"]);
      const idxName = findIndex(["Ø§Ø³Ù…Ø§Ù„Ù…ÙˆØ¸Ù", "Ø§Ø³Ù…Ø§Ù„Ø¹Ø§Ù…Ù„", "Ø§Ù„Ø§Ø³Ù…"]);
      const idxBasic = findIndex(["Ø§Ù„Ø±Ø§ØªØ¨Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ", "Ø±Ø§ØªØ¨Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ"]);
      const idxBonus = findIndex(["Ø§ÙƒØ±Ø§Ù…ÙŠØ©", "Ø­Ø§ÙØ²", "Ø¨Ø¯Ù„"]);
      const idxTotal = findIndex(["Ø§Ø¬Ù…Ø§Ù„ÙŠØ§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚", "Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚"]);
      const idxAdvance = findIndex(["Ø³Ù„ÙØ©Ø¹Ù„Ø§Ù„Ø±Ø§ØªØ¨", "Ø³Ù„ÙØ©Ø¹Ù„Ù‰Ø§Ù„Ø±Ø§ØªØ¨", "Ø³Ù„ÙØ©Ù…Ù†Ø§Ù„Ø±Ø§ØªØ¨"]);
      const idxInstall = findIndex(["Ø³Ù„ÙØ©Ù…Ù‚Ø³Ø·Ø©", "Ø³Ù„ÙÙ‡Ù…Ù‚Ø³Ø·Ø©"]);
      const idxAbsence = findIndex(["ØºÙŠØ§Ø¨"]);
      const idxForced = findIndex(["Ø§Ø¬Ø§Ø²Ø©Ø§Ø¬Ø¨Ø§Ø±ÙŠØ©Ø¨Ø±Ø§ØªØ¨", "Ø§Ø¬Ø§Ø²Ø©Ø¨Ø±Ø§ØªØ¨"]);
      const idxNet = findIndex(["ØµØ§ÙÙŠØ§Ù„Ø±Ø§ØªØ¨", "ØµØ§ÙÙŠØ§Ù„Ø±Ø§ØªØ¨"]);

      const required = [
        { idx: idxCode, name: "Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù" },
        { idx: idxName, name: "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" },
        { idx: idxBasic, name: "Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ" },
        { idx: idxBonus, name: "Ø§Ù„Ø£ÙƒØ±Ø§Ù…ÙŠØ©" },
        { idx: idxNet, name: "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨" },
        { idx: idxAbsence, name: "ØºÙŠØ§Ø¨" }
      ];

      const missing = required.filter((c) => c.idx === -1);
      if (missing.length) {
        showAlert(
          "ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù„Ù:\n- " +
            missing.map((m) => m.name).join("\n- ") +
            "\n\nØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù…Ø§ Ù‡Ùˆ Ù…ØªØ¹Ø§Ø±Ù Ø¹Ù„ÙŠÙ‡ ÙÙŠ ÙƒØ´Ù Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª."
        );
        return [];
      }

      const rows = [];
      let serial = 1;

      for (let r = 1; r < sheetData.length; r++) {
        const row = sheetData[r];
        if (!row || row.length === 0) continue;

        const code = row[idxCode];
        const name = row[idxName];
        if (!code && !name) continue;

        const basic = toNumber(row[idxBasic]);
        const bonus = toNumber(row[idxBonus]);
        const totalEarn = basic + bonus;

        if (totalEarn <= 0) continue;

        const advanceExisting = idxAdvance !== -1 ? toNumber(row[idxAdvance]) : 0;
        const installmentExisting = idxInstall !== -1 ? toNumber(row[idxInstall]) : 0;
        const advanceCombined = advanceExisting + installmentExisting;

        const absenceMoney = idxAbsence !== -1 ? toNumber(row[idxAbsence]) : 0;
        const forcedMoney = idxForced !== -1 ? toNumber(row[idxForced]) : 0;

        const net = idxNet !== -1 ? toNumber(row[idxNet]) : 0;

        const dailyWage = totalEarn / 30 || 0;
        const bonusPerDay = bonus / 30 || 0;

        const absenceDays = dailyWage > 0 ? absenceMoney / dailyWage : 0;
        const forcedDays = bonusPerDay > 0 ? forcedMoney / bonusPerDay : 0;

        let totalAbsenceDays = absenceDays + forcedDays;
        if (totalAbsenceDays > 31) totalAbsenceDays = 31;

        const presenceDays = Math.max(0, 30 - totalAbsenceDays);

        const percentBase = category === "admins" ? 0.25 : 0.30;
        const percentLabel = category === "admins" ? "Ø³Ù„ÙØ© 25%" : "Ø³Ù„ÙØ© 30%";
        const thresholdHigh = percentBase * totalEarn;

        let decisionType = "";
        let statusCategory = "";
        let statusText = "";
        let note = "";
        let proposedAmount = 0;

        // Ø­Ø§Ù„Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ø§ ÙŠØ³ØªØ­Ù‚
        if (net <= 0) {
          statusCategory = "rejected";
          statusText = "Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ©";
          note = "Ø±ØµÙŠØ¯Ù‡ Ù„Ø§ ÙŠØ³Ù…Ø­ (ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨ = 0)";
          proposedAmount = 0;
        } else if (totalAbsenceDays >= 30) {
          statusCategory = "rejected";
          statusText = "Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ©";
          note = "ØºÙŠØ§Ø¨ 30 ÙŠÙˆÙ…Ø§Ù‹ (Ù…Ù†Ù‚Ø·Ø¹ Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„)";
          proposedAmount = 0;
        } else {
          if (category === "workers") {
            // Ø§Ù„Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ù…Ø´Ø±ÙÙˆÙ† â€” ÙŠÙˆÙ… 15
            if (presenceDays >= 10) {
              decisionType = "Ø³Ù„ÙØ© Ù†Ø¸Ø§Ù…ÙŠØ©";
              proposedAmount = percentBase * totalEarn;
              statusCategory = "normal";
            } else {
              decisionType = "ØªØµÙÙŠØ© / ØªØ¹Ø¨Ø¦Ø©";
              const capAmount = percentBase * totalEarn;
              proposedAmount = Math.min(net, capAmount);
              statusCategory = "settlement";
              note = "Ø­Ø¶ÙˆØ± Ø£Ù‚Ù„ Ù…Ù† 10 Ø£ÙŠØ§Ù… âœ ØªØµÙÙŠØ© Ø­Ø³Ø¨ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨ (Ù…Ø¹ Ø³Ù‚Ù 30%).";
            }

            if (advanceCombined > 0) {
              const ratio = advanceCombined / totalEarn;
              if (ratio >= 0.30) {
                statusCategory = "rejected";
                statusText = "Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ©";
                decisionType = "Ù…Ø±ÙÙˆØ¶";
                note =
                  "Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ â‰¥ 30% Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (Ø§Ø­ØªÙ…Ø§Ù„ Ø³Ø­Ø¨ Ø³Ø§Ø¨Ù‚ / ØªØµÙÙŠØ©).";
                proposedAmount = 0;
              } else {
                statusCategory = "review";
                statusText = "ÙŠØªØ·Ù„Ø¨ ØªØ­Ù‚Ù‚";
                note =
                  "ÙŠÙˆØ¬Ø¯ Ù…Ø¨Ù„Øº ÙÙŠ Ø¹Ù…ÙˆØ¯ Ø³Ù„ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ Ø£Ù‚Ù„ Ù…Ù† 30% â€” ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.";
              }
            }
          } else {
            // Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ†
            if (advanceDay === 10) {
              const minDays = Math.max(1, Math.min(30, Number(adminMinDays) || 7));
              if (presenceDays >= minDays) {
                decisionType = "Ø³Ù„ÙØ© Ù†Ø¸Ø§Ù…ÙŠØ©";
                proposedAmount = percentBase * totalEarn;
                statusCategory = "normal";
                note = `Ø­Ø¶ÙˆØ± ${presenceDays.toFixed(
                  1
                )} ÙŠÙˆÙ…Ù‹Ø§ (â‰¥ ${minDays}) Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ® 10 Ø§Ù„Ø´Ù‡Ø±.`;
              } else {
                decisionType = "ØªØµÙÙŠØ© / ØªØ¹Ø¨Ø¦Ø©";
                const capAmount = percentBase * totalEarn;
                proposedAmount = Math.min(net, capAmount);
                statusCategory = "settlement";
                note = `Ø­Ø¶ÙˆØ± Ø£Ù‚Ù„ Ù…Ù† ${minDays} Ø£ÙŠØ§Ù… Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ® 10 Ø§Ù„Ø´Ù‡Ø± âœ ØªØµÙÙŠØ© Ø­Ø³Ø¨ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨.`;
              }

              if (advanceCombined > 0) {
                const ratio = advanceCombined / totalEarn;
                if (ratio >= 0.25) {
                  statusCategory = "rejected";
                  statusText = "Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ©";
                  decisionType = "Ù…Ø±ÙÙˆØ¶";
                  note =
                    "Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ â‰¥ 25% Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ø³ØªÙ„Ù… Ø³Ù„ÙØ© ÙŠÙˆÙ… 10 Ø£Ùˆ ØªØµÙÙŠØ© Ø³Ø§Ø¨Ù‚Ø©).";
                  proposedAmount = 0;
                } else {
                  statusCategory = "review";
                  statusText = "ÙŠØªØ·Ù„Ø¨ ØªØ­Ù‚Ù‚";
                  note =
                    "ÙŠÙˆØ¬Ø¯ Ù…Ø¨Ù„Øº ÙÙŠ Ø¹Ù…ÙˆØ¯ Ø³Ù„ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ Ø£Ù‚Ù„ Ù…Ù† 25% â€” ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.";
                }
              }
            } else if (advanceDay === 20) {
              const threshold50 = 0.5 * totalEarn;

              if (advanceCombined >= threshold50) {
                statusCategory = "rejected";
                statusText = "Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ©";
                decisionType = "Ù…Ø±ÙÙˆØ¶";
                proposedAmount = 0;
                note =
                  "Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ â‰¥ 50% Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (Ø§Ø³ØªÙ„Ù… Ø³Ù„ÙØ© ÙƒØ¨ÙŠØ±Ø© Ø³Ø§Ø¨Ù‚Ù‹Ø§).";
              } else if (advanceCombined > 0) {
                statusCategory = "review";
                statusText = "ÙŠØªØ·Ù„Ø¨ ØªØ­Ù‚Ù‚";
                decisionType = "Ø³Ù„ÙØ© Ù…Ø­ØªÙ…Ù„Ø©";
                proposedAmount = percentBase * totalEarn;
                note =
                  "ÙŠÙˆØ¬Ø¯ Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© Ø£Ù‚Ù„ Ù…Ù† 50% â€” ÙŠØ­ØªØ§Ø¬ ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù‚Ø¨Ù„ Ù…Ù†Ø­ Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©.";
              } else {
                statusCategory = "normal";
                statusText = "";
                decisionType = "Ø³Ù„ÙØ© Ù†Ø¸Ø§Ù…ÙŠØ©";
                proposedAmount = percentBase * totalEarn;
                note = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.";
              }
            }
          }
        }

        // ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ù†Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯
        if (!statusText) {
          if (statusCategory === "normal") statusText = "Ø³Ù„ÙØ© Ù†Ø¸Ø§Ù…ÙŠØ©";
          else if (statusCategory === "settlement") statusText = "ØªØµÙÙŠØ© / ØªØ¹Ø¨Ø¦Ø©";
          else if (statusCategory === "review") statusText = "ÙŠØªØ·Ù„Ø¨ ØªØ­Ù‚Ù‚";
        }

        const approvedAmount = roundToHundreds(proposedAmount);

        rows.push({
          serial: serial++,
          code,
          name,
          totalEarn,
          advanceExisting: advanceCombined,
          net,
          absenceDays: totalAbsenceDays,
          presenceDays,
          percentLabel,
          decisionType,
          proposedAmount: roundToHundreds(proposedAmount),
          approvedAmount,
          statusCategory,
          statusText,
          note
        });
      }

      return rows;
    }

    function renderTable(rows) {
      resultsBody.innerHTML = "";

      rows.forEach((row) => {
        const tr = document.createElement("tr");
        tr.dataset.status = row.statusCategory;

        if (row.statusCategory === "normal") tr.classList.add("status-normal-row");
        else if (row.statusCategory === "review") tr.classList.add("status-review-row");
        else if (row.statusCategory === "rejected")
          tr.classList.add("status-reject-row");

        const tdSerial = document.createElement("td");
        tdSerial.className = "num col-m";
        tdSerial.textContent = row.serial;

        const tdCode = document.createElement("td");
        tdCode.className = "num col-code";
        tdCode.textContent = row.code;

        const tdName = document.createElement("td");
        tdName.className = "col-name";
        tdName.textContent = row.name;

        const tdTotal = document.createElement("td");
        tdTotal.className = "amount col-total";
        tdTotal.textContent = Math.round(row.totalEarn).toString();

        const tdPrev = document.createElement("td");
        tdPrev.className = "amount col-prev";
        tdPrev.textContent = Math.round(row.advanceExisting).toString();

        const tdNet = document.createElement("td");
        tdNet.className = "amount col-net";
        tdNet.textContent = Math.round(row.net).toString();

        const tdAbs = document.createElement("td");
        tdAbs.className = "num col-days";
        tdAbs.textContent = row.absenceDays.toFixed(1);

        const tdPres = document.createElement("td");
        tdPres.className = "num col-days";
        tdPres.textContent = row.presenceDays.toFixed(1);

        const tdRate = document.createElement("td");
        tdRate.className = "num col-rate";
        tdRate.textContent = row.percentLabel;

        const tdDecision = document.createElement("td");
        tdDecision.className = "col-type";
        tdDecision.textContent = row.decisionType || "-";

        const tdProp = document.createElement("td");
        tdProp.className = "amount col-total";
        tdProp.textContent = row.proposedAmount.toString();

        const tdApproved = document.createElement("td");
        tdApproved.className = "amount col-total";
        tdApproved.textContent = row.approvedAmount.toString();

        const tdStatus = document.createElement("td");
        tdStatus.className = "col-status";
        const badge = document.createElement("span");
        badge.classList.add("badge");
        if (row.statusCategory === "normal") badge.classList.add("status-normal");
        else if (row.statusCategory === "settlement")
          badge.classList.add("status-settle");
        else if (row.statusCategory === "review")
          badge.classList.add("status-review");
        else if (row.statusCategory === "rejected")
          badge.classList.add("status-reject");
        badge.textContent = row.statusText || "-";
        tdStatus.appendChild(badge);

        const tdNote = document.createElement("td");
        tdNote.className = "col-note";
        tdNote.textContent = row.note || "";

        tr.appendChild(tdSerial);
        tr.appendChild(tdCode);
        tr.appendChild(tdName);
        tr.appendChild(tdTotal);
        tr.appendChild(tdPrev);
        tr.appendChild(tdNet);
        tr.appendChild(tdAbs);
        tr.appendChild(tdPres);
        tr.appendChild(tdRate);
        tr.appendChild(tdDecision);
        tr.appendChild(tdProp);
        tr.appendChild(tdApproved);
        tr.appendChild(tdStatus);
        tr.appendChild(tdNote);

        resultsBody.appendChild(tr);
      });
    }

    function updateStats(rows) {
      const total = rows.length;
      const normal = rows.filter((r) => r.statusCategory === "normal").length;
      const settle = rows.filter((r) => r.statusCategory === "settlement").length;
      const review = rows.filter((r) => r.statusCategory === "review").length;
      const rejected = rows.filter((r) => r.statusCategory === "rejected").length;

      statTotal.textContent = total;
      statNormal.textContent = normal;
      statSettle.textContent = settle;
      statReview.textContent = review;
      statReject.textContent = rejected;

      countAll.textContent = total;
      countNormal.textContent = normal;
      countSettle.textContent = settle;
      countReview.textContent = review;
      countRejected.textContent = rejected;
    }

    function applyFilter(filter) {
      currentFilter = filter;
      filterButtons.forEach((btn) => {
        if (btn.dataset.filter === filter) btn.classList.add("active");
        else btn.classList.remove("active");
      });

      const rows = Array.from(resultsBody.querySelectorAll("tr"));
      rows.forEach((tr) => {
        const status = tr.dataset.status;
        if (filter === "all" || status === filter) {
          tr.style.display = "";
        } else {
          tr.style.display = "none";
        }
      });
    }

    // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø© (Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±)
    filterButtons.forEach((btn) => {
      const handler = (ev) => {
        ev.preventDefault();
        applyFilter(btn.dataset.filter);
      };
      btn.addEventListener("click", handler);
      btn.addEventListener("touchstart", handler, { passive: true });
    });

    async function handleStart() {
      if (!fileInput.files || fileInput.files.length === 0) {
        showAlert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙƒØ´Ù Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }

      const file = fileInput.files[0];

      try {
        startBtn.disabled = true;
        startBtn.textContent = "â³ Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
        downloadBtn.disabled = true;
        resultsBody.innerHTML = "";
        parsedRows = [];
        updateStats([]);

        const workbook = await readWorkbook(file);
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];

        const category = categorySelect.value === "admins" ? "admins" : "workers";
        const advanceDay = Number(dateSelect.value || "15");
        const adminMinDaysVal = Number(adminMinDaysInput.value || "7");

        const rows = buildRowsFromSheet(
          sheet,
          category,
          advanceDay,
          adminMinDaysVal
        );
        parsedRows = rows;
        renderTable(rows);
        updateStats(rows);
        applyFilter("all");
        downloadBtn.disabled = rows.length === 0;
      } catch (err) {
        console.error(err);
        showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© XLSX ØµØ­ÙŠØ­Ø©.");
      } finally {
        startBtn.disabled = false;
        startBtn.textContent = "ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨";
      }
    }

    startBtn.addEventListener("click", handleStart);

    function downloadWorkbook() {
      if (!parsedRows || parsedRows.length === 0) {
        showAlert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }

      const detailedData = [
        [
          "Ù…",
          "Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
          "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
          "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚",
          "Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø©",
          "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨",
          "Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨",
          "Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±",
          "Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ù„ÙØ©",
          "Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø±Ø§Ø±",
          "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù‚ØªØ±Ø­",
          "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹ØªÙ…Ø¯",
          "Ø§Ù„Ø­Ø§Ù„Ø©",
          "Ù…Ù„Ø§Ø­Ø¸Ø©"
        ]
      ];

      parsedRows.forEach((r) => {
        detailedData.push([
          r.serial,
          r.code,
          r.name,
          Math.round(r.totalEarn),
          Math.round(r.advanceExisting),
          Math.round(r.net),
          Number(r.absenceDays.toFixed(2)),
          Number(r.presenceDays.toFixed(2)),
          r.percentLabel,
          r.decisionType,
          r.proposedAmount,
          r.approvedAmount,
          r.statusText,
          r.note
        ]);
      });

      // ÙˆØ±Ù‚Ø© Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ© (Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…)
      const grantData = [];
      parsedRows.forEach((r) => {
        if (r.approvedAmount > 0 && r.statusCategory !== "rejected") {
          grantData.push([r.code, r.name, r.approvedAmount, "YER"]);
        }
      });

      const wb = XLSX.utils.book_new();
      const wsDetail = XLSX.utils.aoa_to_sheet(detailedData);
      XLSX.utils.book_append_sheet(wb, wsDetail, "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©");

      const wsGrant = XLSX.utils.aoa_to_sheet(grantData);
      XLSX.utils.book_append_sheet(wb, wsGrant, "Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ©");

      const fileName = "Ø³Ù„ÙØ©_Ø´Ù‡Ø±ÙŠØ©_HR.xlsx";
      XLSX.writeFile(wb, fileName);
    }

    downloadBtn.addEventListener("click", downloadWorkbook);
  </script>
</body>
          </html>
