<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ - HR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Tahoma, sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
    }
    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }
    header {
      text-align: center;
      margin-bottom: 16px;
    }
    header h1 {
      font-size: 1.4rem;
      margin: 0;
      color: #38bdf8;
      font-weight: 800;
    }
    header p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #cbd5f5;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 10px 25px rgba(15,23,42,0.7);
      border: 1px solid #1f2937;
      margin-bottom: 12px;
    }
    .card h2 {
      margin: 0 0 10px;
      font-size: 1rem;
      color: #f9fafb;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .field-label {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .file-input-wrapper {
      position: relative;
      border-radius: 10px;
      background: #020617;
      border: 1px dashed #4b5563;
      overflow: hidden;
    }
    .file-input {
      opacity: 0;
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .file-input-label-overlay {
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      font-size: 0.8rem;
      color: #e5e7eb;
    }
    .file-input-label-overlay .name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .file-input-label-overlay .btn {
      background: #0ea5e9;
      color: #0b1120;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    select, input[type="number"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
      outline: none;
    }
    select:focus, input[type="number"]:focus {
      border-color: #0ea5e9;
      box-shadow: 0 0 0 1px rgba(14,165,233,0.4);
    }
    .select-inline-label {
      font-size: 0.7rem;
      color: #9ca3af;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #38bdf8);
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: 700;
      color: #0b1120;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #111827;
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 8px 12px;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-secondary:hover {
      border-color: #0ea5e9;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .stat-card {
      border-radius: 10px;
      padding: 8px;
      font-size: 0.8rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top, rgba(56,189,248,0.15), #020617);
    }
    .stat-label {
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 1rem;
      font-weight: 700;
      color: #e5e7eb;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 8px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      max-height: 400px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
      font-size: 0.8rem;
    }
    thead {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
    }
    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 4px 6px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      font-size: 0.75rem;
      color: #9ca3af;
      position: sticky;
      top: 0;
      background: #020617;
    }
    td {
      font-size: 0.8rem;
      color: #e5e7eb;
    }
    td.name-cell {
      text-align: right;
      min-width: 160px;
      max-width: 260px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    td.note-cell {
      text-align: right;
      min-width: 200px;
      max-width: 320px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .status-approved {
      background: rgba(22,163,74,0.18);
    }
    .status-settle {
      background: rgba(59,130,246,0.18);
    }
    .status-pending {
      background: rgba(245,158,11,0.18);
    }
    .status-reject {
      background: rgba(220,38,38,0.2);
    }
    .status-pill {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
    }
    .status-pill.approved {
      background: rgba(22,163,74,0.18);
      color: #bbf7d0;
    }
    .status-pill.settle {
      background: rgba(59,130,246,0.18);
      color: #dbeafe;
    }
    .status-pill.pending {
      background: rgba(245,158,11,0.18);
      color: #fed7aa;
    }
    .status-pill.reject {
      background: rgba(220,38,38,0.22);
      color: #fecaca;
    }
    footer {
      margin-top: 16px;
      text-align: center;
      font-size: 0.75rem;
      color: #9ca3af;
      line-height: 1.5;
    }
    footer span {
      display: block;
    }
    @media (max-width: 640px) {
      header h1 {
        font-size: 1.1rem;
      }
      .card {
        padding: 10px;
      }
      th, td {
        padding: 3px 4px;
      }
    }
  </style>
  <script src="xlsx.full.min.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <h1>Ù†Ø¸Ø§Ù… Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</h1>
      <p>Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙƒÙ†Ø§Ø±ÙŠ Ù„Ù„ØµÙ†Ø§Ø¹Ø§Øª Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© HR</p>
    </header>

    <section class="card">
      <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ù„ÙØ©</h2>
      <div class="grid">
        <div class="field">
          <div class="field-label">Ù…Ù„Ù ÙƒØ´Ù Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª (XLSX)</div>
          <div class="file-input-wrapper">
            <input id="file-input" type="file" accept=".xlsx" class="file-input" />
            <div class="file-input-label-overlay">
              <span class="name" id="file-name-label">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯â€¦</span>
              <span class="btn">Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§</span>
            </div>
          </div>
          <div class="select-inline-label">ÙŠÙØ¶Ù‘Ù„ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù ØµØ§Ø¯Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† ÙƒØ´Ù Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ.</div>
        </div>

        <div class="field">
          <div class="field-label">Ù†ÙˆØ¹ Ø§Ù„ÙØ¦Ø©</div>
          <select id="category-select">
            <option value="workers">Ø§Ù„Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ù…Ø´Ø±ÙÙŠÙ† â€” Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ù„ÙØ© (30%)</option>
            <option value="admins">Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ† â€” Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ù„ÙØ© (25%)</option>
          </select>
          <div class="select-inline-label">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙØ¦Ø© Ø­Ø³Ø¨ ÙƒØ´Ù Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª Ø§Ù„Ø°ÙŠ ØªØ¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡.</div>
        </div>

        <div class="field">
          <div class="field-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù„ÙØ©</div>
          <select id="date-select"></select>
          <div class="select-inline-label">ÙŠØ³ØªØ®Ø¯Ù… Ù„Ø¶Ø¨Ø· Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø³Ù„ÙØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ† (10 Ø£Ùˆ 20 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±).</div>
        </div>

        <div class="field" id="admin-min-days-field" style="display:none">
          <div class="field-label">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± (Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ† â€” Ø³Ù„ÙØ© ÙŠÙˆÙ… 10)</div>
          <input id="admin-min-days" type="number" min="0" max="30" value="7" />
          <div class="select-inline-label">
            Ù…Ø«Ø§Ù„: 7 = ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø­Ø¶ÙˆØ± 7 Ø£ÙŠØ§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ù„ÙØ© Ù†Ø³Ø¨Ø© ÙÙŠ ÙŠÙˆÙ… 10 Ù„Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ†.
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="process-btn" class="btn-primary">
          ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨
        </button>
        <button id="download-btn" class="btn-secondary" disabled>
          ğŸ’¾ ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø³Ù„ÙØ© XLSX
        </button>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
          <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Ø³Ù„ÙØ© Ù†Ø¸Ø§Ù…ÙŠØ© (Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§)</div>
          <div class="stat-value" id="stat-approved">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ØªØµÙÙŠØ© / ØªØ¹Ø¨Ø¦Ø©</div>
          <div class="stat-value" id="stat-settle">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ÙŠØªØ·Ù„Ø¨ ØªØ­Ù‚Ù‚</div>
          <div class="stat-value" id="stat-pending">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Ù„Ø§ ÙŠØ³ØªØ­Ù‚ / Ù…Ø±ÙÙˆØ¶</div>
          <div class="stat-value" id="stat-reject">0</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h2>
      <div class="table-wrapper">
        <table id="result-table">
          <thead>
            <tr>
              <th>Ù…</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
              <th>Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø©</th>
              <th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>
              <th>Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</th>
              <th>Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</th>
              <th id="advance-percent-header">Ø³Ù„ÙØ© %</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø±Ø§Ø±</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù‚ØªØ±Ø­</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹ØªÙ…Ø¯</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
            </tr>
          </thead>
          <tbody id="result-body">
          </tbody>
        </table>
      </div>
    </section>

    <footer>
      <span>Ù†Ø¸Ø§Ù… Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© - Ø§Ù„ÙŠÙ…Ù†</span>
      <span>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³/ Ø­Ù…Ø¯ÙŠ Ø§Ù„Ø¹Ø±ÙŠÙ‚ÙŠ â€“ Øª: 773143600</span>
      <span>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025</span>
    </footer>
  </div>

  <script>
    const fileInput = document.getElementById("file-input");
    const fileNameLabel = document.getElementById("file-name-label");
    const categorySelect = document.getElementById("category-select");
    const dateSelect = document.getElementById("date-select");
    const adminMinDaysField = document.getElementById("admin-min-days-field");
    const adminMinDaysInput = document.getElementById("admin-min-days");
    const processBtn = document.getElementById("process-btn");
    const downloadBtn = document.getElementById("download-btn");
    const resultBody = document.getElementById("result-body");
    const advancePercentHeader = document.getElementById("advance-percent-header");

    const statTotal = document.getElementById("stat-total");
    const statApproved = document.getElementById("stat-approved");
    const statSettle = document.getElementById("stat-settle");
    const statPending = document.getElementById("stat-pending");
    const statReject = document.getElementById("stat-reject");

    let currentResults = [];
    let currentPercentLabel = "Ø³Ù„ÙØ© %";

    function toNumber(value) {
      if (value === null || value === undefined) return 0;
      if (typeof value === "number") return isNaN(value) ? 0 : value;
      const str = String(value).toString().replace(/[^\d\.\-]/g, "");
      const n = parseFloat(str);
      return isNaN(n) ? 0 : n;
    }

    function roundMoney(num) {
      return Math.round(num);
    }

    // ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ø³ÙÙ„ Ù„Ø£Ù‚Ø±Ø¨ 100 Ø±ÙŠØ§Ù„ (Ù…Ø«Ù„Ø§Ù‹ 8417 â†’ 8400)
    function roundToHundredDown(num) {
      if (!isFinite(num)) return 0;
      if (num <= 0) return 0;
      return Math.floor(num / 100) * 100;
    }

    function normalizeHeader(h) {
      return String(h || "")
        .replace(/\s+/g, "")
        .replace(/[^\u0600-\u06FFa-zA-Z0-9]/g, "")
        .toLowerCase();
    }

    function findColumn(headers, candidates) {
      const normalized = headers.map(normalizeHeader);
      for (let key of candidates) {
        const nk = normalizeHeader(key);
        const idx = normalized.indexOf(nk);
        if (idx !== -1) return headers[idx];
      }
      return null;
    }

    function syncDateOptions() {
      const cat = categorySelect.value;
      dateSelect.innerHTML = "";
      if (cat === "workers") {
        const opt = document.createElement("option");
        opt.value = "15";
        opt.textContent = "Ø³Ù„ÙØ© ÙŠÙˆÙ… 15 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±";
        dateSelect.appendChild(opt);
      } else {
        const opt10 = document.createElement("option");
        opt10.value = "10";
        opt10.textContent = "Ø³Ù„ÙØ© ÙŠÙˆÙ… 10 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±";
        dateSelect.appendChild(opt10);

        const opt20 = document.createElement("option");
        opt20.value = "20";
        opt20.textContent = "Ø³Ù„ÙØ© ÙŠÙˆÙ… 20 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±";
        dateSelect.appendChild(opt20);
      }
    }

    function updatePercentHeader() {
      const cat = categorySelect.value;
      currentPercentLabel = cat === "workers" ? "Ø³Ù„ÙØ© 30%" : "Ø³Ù„ÙØ© 25%";
      advancePercentHeader.textContent = currentPercentLabel;
    }

    function updateAdminMinDaysVisibility() {
      const cat = categorySelect.value;
      const d = dateSelect.value;
      if (cat === "admins" && d === "10") {
        adminMinDaysField.style.display = "block";
      } else {
        adminMinDaysField.style.display = "none";
      }
    }

    categorySelect.addEventListener("change", () => {
      updatePercentHeader();
      syncDateOptions();
      updateAdminMinDaysVisibility();
    });

    dateSelect.addEventListener("change", () => {
      updateAdminMinDaysVisibility();
    });

    fileInput.addEventListener("change", () => {
      if (fileInput.files && fileInput.files[0]) {
        fileNameLabel.textContent = fileInput.files[0].name;
      } else {
        fileNameLabel.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯â€¦";
      }
    });

    updatePercentHeader();
    syncDateOptions();
    updateAdminMinDaysVisibility();

    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
            resolve(rows);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = (err) => reject(err);
        reader.readAsArrayBuffer(file);
      });
    }

    function processRows(rows, category, advanceDate) {
      if (!rows || !rows.length) return [];

      const headers = Object.keys(rows[0]);

      const colCode = findColumn(headers, ["Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù", "Ø±Ù‚Ù…Ø§Ù„Ù…ÙˆØ¸Ù", "Ø§Ù„ÙƒÙˆØ¯"]);
      const colName = findColumn(headers, ["Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù", "Ø§Ø³Ù…Ø§Ù„Ù…ÙˆØ¸Ù", "Ø§Ù„Ø§Ø³Ù…"]);
      const colBasic = findColumn(headers, ["Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ", "Ø§Ù„Ø±Ø§ØªØ¨Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ"]);
      const colBonus = findColumn(headers, ["Ø§ÙƒØ±Ø§Ù…ÙŠØ©", "Ø§Ù„Ø¥ÙƒØ±Ø§Ù…ÙŠØ©"]);
      const colGross = findColumn(headers, ["Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚", "Ø§Ø¬Ù…Ø§Ù„ÙŠØ§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚"]);
      const colLoan = findColumn(headers, ["Ø³Ù„ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨", "Ø³Ù„ÙØ©Ø¹Ù„Ù‰Ø§Ù„Ø±Ø§ØªØ¨"]);
      const colInstLoan = findColumn(headers, ["Ø³Ù„ÙØ© Ù…Ù‚Ø³Ø·Ø©", "Ø³Ù„ÙØ©Ù…Ù‚Ø³Ø·Ø©"]);
      const colAbsenceMoney = findColumn(headers, ["ØºÙŠØ§Ø¨"]);
      const colAbsenceDays = findColumn(headers, ["Ø§ÙŠØ§Ù… ØºÙŠØ§Ø¨", "Ø§ÙŠØ§Ù…ØºÙŠØ§Ø¨", "Ø§ÙŠØ§Ù…Øº", "Ø£ÙŠØ§Ù…ØºÙŠØ§Ø¨"]);
      const colForcedLeave = findColumn(headers, ["Ø§Ø¬Ø§Ø²Ø© Ø§Ø¬Ø¨Ø§Ø±ÙŠØ© Ø¨Ø±Ø§ØªØ¨", "Ø§Ø¬Ø§Ø²Ø©Ø§Ø¬Ø¨Ø§Ø±ÙŠØ©Ø¨Ø±Ø§ØªØ¨"]);
      const colNet = findColumn(headers, ["ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨", "ØµØ§ÙÙŠØ§Ù„Ø±Ø§ØªØ¨", "ØµØ§ÙÙŠØ±Ø§ØªØ¨"]);

      if (!colCode || !colName || !colBasic || !colBonus || !colNet) {
        alert("Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù (Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸ÙØŒ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙØŒ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØŒ Ø§Ù„Ø£ÙƒØ±Ø§Ù…ÙŠØ©ØŒ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨).");
        return [];
      }

      const results = [];
      const percent = category === "workers" ? 0.30 : 0.25;
      const monthlyCapPercent =
        category === "workers"
          ? 0.30
          : (advanceDate === "10" ? 0.25 : 0.50);

      currentPercentLabel = category === "workers" ? "Ø³Ù„ÙØ© 30%" : "Ø³Ù„ÙØ© 25%";
      advancePercentHeader.textContent = currentPercentLabel;

      const adminMinDays = toNumber(adminMinDaysInput ? adminMinDaysInput.value : 7);

      rows.forEach((row, idx) => {
        const index = idx + 1;
        const code = row[colCode];
        const name = row[colName];

        const basic = toNumber(row[colBasic]);
        const bonus = toNumber(row[colBonus]);
        let gross = basic + bonus;

        const grossSystem = colGross ? toNumber(row[colGross]) : 0;
        if (grossSystem > 0 && Math.abs(grossSystem - gross) > 1) {
          gross = basic + bonus;
        }

        const net = toNumber(row[colNet]);
        const loanOnSalary = colLoan ? toNumber(row[colLoan]) : 0;
        const instLoan = colInstLoan ? toNumber(row[colInstLoan]) : 0;
        const existingLoan = loanOnSalary + instLoan;

        const dayWage = gross > 0 ? gross / 30 : 0;

        let absenceDays = 0;
        if (colAbsenceDays) {
          absenceDays = toNumber(row[colAbsenceDays]);
        } else if (colAbsenceMoney) {
          const absenceMoney = toNumber(row[colAbsenceMoney]);
          absenceDays = dayWage > 0 ? (absenceMoney / dayWage) : 0;
        }

        const forcedLeaveMoney = colForcedLeave ? toNumber(row[colForcedLeave]) : 0;
        const perDayBonus = bonus > 0 ? (bonus / 30) : 0;
        const forcedDays = perDayBonus > 0 ? (forcedLeaveMoney / perDayBonus) : 0;

        const totalAbsence = absenceDays + forcedDays;
        const presenceDays = Math.max(0, 30 - totalAbsence);

        let percentBaseAmount = gross * percent;
        const monthlyCapAmount = gross * monthlyCapPercent;

        let decisionType = "";
        let status = "";
        let suggestedAmount = 0;
        let finalAmount = 0;
        let note = "";

        if (totalAbsence >= 30) {
          status = "reject";
          decisionType = "Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ© â€” ØºÙŠØ§Ø¨ 30 ÙŠÙˆÙ…";
          note = "Ø§Ù„Ø¹Ø§Ù…Ù„ Ù…Ù†Ù‚Ø·Ø¹ Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ 30 ÙŠÙˆÙ…Ù‹Ø§ (Ø£Ùˆ Ø£ÙƒØ«Ø±)ØŒ Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.";
          suggestedAmount = 0;
          finalAmount = 0;
        } else if (net <= 0) {
          status = "reject";
          decisionType = "Ù„Ø§ ÙŠØ³ØªØ­Ù‚ Ø³Ù„ÙØ© â€” Ø±ØµÙŠØ¯Ù‡ Ù„Ø§ ÙŠØ³Ù…Ø­";
          note = "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨ ÙŠØ³Ø§ÙˆÙŠ ØµÙØ± Ø£Ùˆ Ø£Ù‚Ù„Ø› Ø±Ø¨Ù…Ø§ ØªÙ…Øª ØªØµÙÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ Ù…ØªØ§Ø­.";
          suggestedAmount = 0;
          finalAmount = 0;
        } else {
          if (category === "workers") {
            if (presenceDays >= 10) {
              suggestedAmount = percentBaseAmount;
              decisionType = "Ø³Ù„ÙØ© Ù†Ø³Ø¨Ø© (" + Math.round(percent * 100) + "%)";
              status = "approved";
            } else {
              const base = Math.min(net, percentBaseAmount);
              suggestedAmount = base;
              decisionType = "ØªØµÙÙŠØ© (Ø£Ù‚Ù„ Ù…Ù† 10 Ø£ÙŠØ§Ù… Ø­Ø¶ÙˆØ±)";
              status = "settle";
            }
          } else {
            if (advanceDate === "10") {
              if (presenceDays >= adminMinDays) {
                suggestedAmount = percentBaseAmount;
                decisionType = "Ø³Ù„ÙØ© Ù†Ø³Ø¨Ø© (" + Math.round(percent * 100) + "%)";
                status = "approved";
              } else {
                const base = Math.min(net, percentBaseAmount);
                suggestedAmount = base;
                decisionType = "ØªØµÙÙŠØ© (Ø£Ù‚Ù„ Ù…Ù† " + adminMinDays + " Ø£ÙŠØ§Ù… Ø­Ø¶ÙˆØ± Ù„Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ† ÙÙŠ Ø³Ù„ÙØ© ÙŠÙˆÙ… 10)";
                status = "settle";
              }
            } else {
              const absenceForRule = totalAbsence;
              if (absenceForRule <= 3) {
                suggestedAmount = percentBaseAmount;
                decisionType = "Ø³Ù„ÙØ© Ù†Ø³Ø¨Ø© (" + Math.round(percent * 100) + "%)";
                status = "approved";
              } else {
                const base = Math.min(net, percentBaseAmount);
                suggestedAmount = base;
                decisionType = "ØªØµÙÙŠØ© (ØºÙŠØ§Ø¨ Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„ÙØªØ±Ø©)";
                status = "settle";
              }
            }
          }

          finalAmount = suggestedAmount;

          if (loanOnSalary > 0) {
            if (loanOnSalary >= monthlyCapAmount) {
              status = "reject";
              decisionType = "Ù…Ø±ÙÙˆØ¶ â€” Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© â‰¥ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ";
              suggestedAmount = 0;
              finalAmount = 0;
              note =
                `Ø³Ù„ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† = ${roundMoney(loanOnSalary)} ` +
                `â‰¥ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (${roundMoney(monthlyCapAmount)}). Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù†ÙØ³ Ø§Ù„Ø´Ù‡Ø±.`;
            } else {
              status = "pending";
              const remainingForMonth = monthlyCapAmount - loanOnSalary;
              const allowedThisRun = Math.min(percentBaseAmount, remainingForMonth);
              suggestedAmount = allowedThisRun;
              finalAmount = allowedThisRun;
              decisionType = "ÙŠØªØ·Ù„Ø¨ ØªØ­Ù‚Ù‚ â€” Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„Ø´Ù‡Ø±";
              note =
                `Ø³Ù„ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† = ${roundMoney(loanOnSalary)} Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ (${roundMoney(monthlyCapAmount)}). ` +
                `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± = ${roundMoney(remainingForMonth)}ØŒ ` +
                `ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù‚ØªØ±Ø­ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© = ${roundMoney(allowedThisRun)}.`;
            }
          }
        }

        percentBaseAmount = roundToHundredDown(percentBaseAmount);
        suggestedAmount = roundToHundredDown(suggestedAmount);
        finalAmount = roundToHundredDown(finalAmount);

        const statusLabelMap = {
          approved: "Ø³Ù„ÙØ© Ù†Ø¸Ø§Ù…ÙŠØ©",
          settle: "ØªØµÙÙŠØ©/ØªØ¹Ø¨Ø¦Ø©",
          pending: "ÙŠØªØ·Ù„Ø¨ ØªØ­Ù‚Ù‚",
          reject: "Ù„Ø§ ÙŠØ³ØªØ­Ù‚ / Ù…Ø±ÙÙˆØ¶"
        };
        const statusLabel = statusLabelMap[status] || status;

        results.push({
          index,
          code,
          name,
          gross: Math.round(gross),
          existingLoan: Math.round(existingLoan),
          net: Math.round(net),
          totalAbsence: parseFloat(totalAbsence.toFixed(2)),
          presenceDays: parseFloat(presenceDays.toFixed(2)),
          percentBaseAmount: percentBaseAmount,
          decisionType,
          suggestedAmount,
          finalAmount,
          status,
          statusLabel,
          note
        });
      });

      return results;
    }

    function renderResults(results) {
      resultBody.innerHTML = "";
      let countAll = 0, countApproved = 0, countSettle = 0, countPending = 0, countReject = 0;

      results.forEach(row => {
        countAll++;
        if (row.status === "approved") countApproved++;
        else if (row.status === "settle") countSettle++;
        else if (row.status === "pending") countPending++;
        else if (row.status === "reject") countReject++;

        const tr = document.createElement("tr");
        tr.classList.add("status-" + row.status);

        tr.innerHTML = `
          <td>${row.index}</td>
          <td>${row.code ?? ""}</td>
          <td class="name-cell" title="${row.name ?? ""}">${row.name ?? ""}</td>
          <td>${row.gross}</td>
          <td>${row.existingLoan}</td>
          <td>${row.net}</td>
          <td>${row.totalAbsence}</td>
          <td>${row.presenceDays}</td>
          <td>${row.percentBaseAmount}</td>
          <td>${row.decisionType}</td>
          <td>${row.suggestedAmount}</td>
          <td>${row.finalAmount}</td>
          <td>
            <span class="status-pill ${row.status}">${row.statusLabel}</span>
          </td>
          <td class="note-cell" title="${row.note ?? ""}">${row.note ?? ""}</td>
        `;
        resultBody.appendChild(tr);
      });

      statTotal.textContent = countAll;
      statApproved.textContent = countApproved;
      statSettle.textContent = countSettle;
      statPending.textContent = countPending;
      statReject.textContent = countReject;

      downloadBtn.disabled = results.length === 0;
    }

    async function handleProcess() {
      if (!fileInput.files || !fileInput.files[0]) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙƒØ´Ù Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const file = fileInput.files[0];
      processBtn.disabled = true;
      processBtn.textContent = "â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨â€¦";

      try {
        const rows = await readExcelFile(file);
        const category = categorySelect.value;
        const advanceDate = dateSelect.value;

        const results = processRows(rows, category, advanceDate);
        currentResults = results;
        renderResults(results);
      } catch (err) {
        console.error(err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© XLSX ÙˆØºÙŠØ± ØªØ§Ù„Ù.");
      } finally {
        processBtn.disabled = false;
        processBtn.textContent = "ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨";
      }
    }

    function handleDownload() {
      if (!currentResults || !currentResults.length) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„ØªÙ†Ø²ÙŠÙ„Ù‡Ø§.");
        return;
      }

      const wsData1 = [];
      wsData1.push([
        "Ù…",
        "Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
        "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
        "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚",
        "Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø©",
        "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨",
        "Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨",
        "Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±",
        currentPercentLabel,
        "Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø±Ø§Ø±",
        "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù‚ØªØ±Ø­",
        "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹ØªÙ…Ø¯",
        "Ø§Ù„Ø­Ø§Ù„Ø©",
        "Ù…Ù„Ø§Ø­Ø¸Ø©"
      ]);

      currentResults.forEach(r => {
        wsData1.push([
          r.index,
          r.code ?? "",
          r.name ?? "",
          r.gross,
          r.existingLoan,
          r.net,
          r.totalAbsence,
          r.presenceDays,
          r.percentBaseAmount,
          r.decisionType,
          r.suggestedAmount,
          r.finalAmount,
          r.statusLabel,
          r.note ?? ""
        ]);
      });

      const ws1 = XLSX.utils.aoa_to_sheet(wsData1);

      const wsData2 = [];
      currentResults
        .filter(r => r.finalAmount > 0 && r.status !== "reject")
        .forEach(r => {
          wsData2.push([
            r.code ?? "",
            r.name ?? "",
            r.finalAmount,
            "YER"
          ]);
        });

      const ws2 = XLSX.utils.aoa_to_sheet(wsData2);

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws1, "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©");
      XLSX.utils.book_append_sheet(wb, ws2, "Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ©");

      XLSX.writeFile(wb, "kanari_monthly_advance_hr.xlsx");
    }

    processBtn.addEventListener("click", handleProcess);
    downloadBtn.addEventListener("click", handleDownload);
  </script>
</body>
</html>
